{% extends "base.html" %}
{% block head %}
<style>
    .button{
        position:fixed;
        top:40%;
    }
    #buttonr{
        position:fixed;
        top:55%;
    }
#progress_in{
    position:fixed;
    top:70%;
}
#progress{
    position:fixed;
    top:70%;
}
</style>
{% endblock %}
{% block body %}
{% block logo %}{% endblock %}
{% block dh %}{% endblock %}
<div class="container-fluid">
    <div class="row">
        {% if mess %}
        <div class="text-center">
            {{ mess }}
        </div>
        {% endif %}
        <form enctype="multipart/form-data" action="{{ url_for('admin.upload') }}" method="POST">
            {{ form.hidden_tag() }}
				<div class="col-md-4 col-sm-4 col-xs-4 col-md-offset-2 col-xs-offset-2 col-sm-offset-2 button">
                    {{ form.video(class="filestyle", style="opacity: 0; position:absolute; height:100%; width:93%;",tabindex="-1",multiple="multiple") }}
                    <button type="form-group" class="btn  btn-primary  btn-lg btn-block">
                        <label for="input03" style="margin-bottom:0">
                            <span class="glyphicon glyphicon glyphicon-cloud" aria-hidden="true"></span><br>
                            <span>选择视频</span>
                        </label>
                    </button>
                </div>
                <div class="col-md-4 col-sm-4 col-xs-4 col-md-offset-6 col-xs-offset-6 col-sm-offset-6 button">
                    {{ form.image(class="filestyle", style="opacity: 0; position:absolute; height:100%; width:93%;",tabindex="-1",multiple="multiple") }}
                    <button type="form-group" class="btn  btn-primary  btn-lg btn-block">
                        <label for="input03" style="margin-bottom:0">
                            <span class="glyphicon glyphicon glyphicon-cloud" aria-hidden="true"></span><br>
                            <span>选择图片</span>
                        </label>
                    </button>
                </div>
                <div id="buttonr" class="col-md-12 col-xs-12 col-sm-12">
                    <div class="col-md-2 col-xs-2 col-sm-2 col-md-offset-4 col-xs-offset-4 col-sm-offset-4 text-center">
                    <button  type="submit" class="btn btn-default   btn-lg">上传</button>
                    </div>
                    <div class="col-md-2 col-xs-2 col-sm-2 text-center">
                    <button type="reset" class="btn btn-default  btn-lg">重置</button>
                    </div>
                </div>
            {% for error in form.video.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </form>
  </div>
    <div id="progress" class="progress progress-striped col-xs-12" style="display:none;">
        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            0%
        </div>
    </div>
</div>

<script type="text/javascript">
    $('form').on('submit', function (event) {
        // 显示进度条
        $('.progress').css('display','block');
        // 阻止元素发生默认的行为，此处用来阻止对表单的提交
        event.preventDefault();
        var formData = new FormData(this);
        // jQuery Ajax 上传文件，关键在于设置：processData 和 contentType
        $.ajax({
            xhr: function () {
                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        var percent = Math.round(e.loaded * 100 / e.total);
                        $('.progress-bar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
                    }
                });
                return xhr;
            },
            type: 'POST',
            url: '{{ url_for('admin.upload') }}',
            cache: false,
            data: formData,
            // 告诉 jQuery 不要去处理发送的数据
            processData: false,
            // 告诉 jQuery 不要去设置 Content-Type 请求头
            // 因为这里是由 <form> 表单构造的 FormData 对象，且已经声明了属性 enctype="multipart/form-data"，所以设置为 false
            contentType: false
        }).done(function (res) {
            if(res=='success'){
                alert('上传成功!');
            }
            else{
                alert('上传失败!请确认文件格式！');
            }
             $('.progress').css('display','none');
        }).fail(function (res) {
            alert('上传失败!');
        });
    });
</script>
{% endblock %}
